<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#2C5F7C">
<title>AIã•ã‚“ã„ã‚“ã‚³ãƒ³ã‚»ãƒ«ã‚¸ãƒ¥ ååˆºç®¡ç†ãƒ¡ãƒ¼ãƒªãƒ³ã‚°ãƒªã‚¹ãƒˆãã‚“</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“‡</text></svg>">
<style>
@import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&family=M+PLUS+Rounded+1c:wght@300;400;500;700&display=swap');

:root {
  --camel: #D4894A;
  --camel-light: #F5E6D3;
  --camel-bg: #FFF8F0;
  --dragon: #C74B50;
  --dragon-light: #FFE0E0;
  --dragon-bg: #FFF5F5;
  --sheep: #7B8EC8;
  --sheep-light: #E8ECF8;
  --sheep-bg: #F5F7FF;
  --primary: #2C5F7C;
  --primary-light: #E3F0F7;
  --bg: #FAFBFE;
  --card-bg: #FFFFFF;
  --text: #2D3748;
  --text-light: #718096;
  --border: #E2E8F0;
  --success: #48BB78;
  --warning: #ECC94B;
  --danger: #FC8181;
  --shadow: 0 4px 20px rgba(0,0,0,0.06);
  --shadow-hover: 0 8px 30px rgba(0,0,0,0.12);
  --radius: 16px;
  --radius-sm: 10px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'M PLUS Rounded 1c', 'Zen Maru Gothic', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}

/* ===== Splash Screen ===== */
#splash {
  position: fixed; inset: 0; z-index: 9999;
  background: linear-gradient(135deg, #FFF8F0 0%, #F5F7FF 50%, #FFF5F5 100%);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  transition: opacity 0.8s ease, visibility 0.8s ease;
}
#splash.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
.splash-logo {
  font-size: 0.75rem; color: var(--text-light);
  letter-spacing: 2px; margin-bottom: 24px;
  text-transform: uppercase;
}
.splash-title {
  font-family: 'Zen Maru Gothic', sans-serif;
  font-size: 1.5rem; font-weight: 900;
  color: var(--primary);
  text-align: center; line-height: 1.6;
  margin-bottom: 8px;
}
.splash-subtitle {
  font-size: 0.95rem; color: var(--text-light);
  text-align: center; margin-bottom: 40px;
}
.splash-characters {
  display: flex; gap: 30px; margin-bottom: 40px;
  animation: floatIn 1s ease-out;
}
@keyframes floatIn {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }
}
.splash-char {
  width: 90px; height: 90px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 2.8rem;
  box-shadow: 0 8px 25px rgba(0,0,0,0.1);
  animation: bounce 2s ease-in-out infinite;
}
.splash-char:nth-child(1) { background: var(--camel-light); animation-delay: 0s; }
.splash-char:nth-child(2) { background: var(--dragon-light); animation-delay: 0.3s; }
.splash-char:nth-child(3) { background: var(--sheep-light); animation-delay: 0.6s; }
.splash-char-label {
  font-size: 0.65rem; font-weight: 700; text-align: center; margin-top: 6px;
}
@keyframes bounce {
  0%,100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}
.splash-start {
  padding: 16px 48px; border: none; border-radius: 50px;
  background: linear-gradient(135deg, var(--camel), var(--dragon), var(--sheep));
  color: #fff; font-family: 'Zen Maru Gothic', sans-serif;
  font-size: 1.1rem; font-weight: 700;
  cursor: pointer; transition: all 0.3s;
  box-shadow: 0 4px 15px rgba(44,95,124,0.3);
}
.splash-start:hover { transform: scale(1.05); box-shadow: 0 6px 25px rgba(44,95,124,0.4); }
.splash-start:active { transform: scale(0.98); }
.splash-version {
  margin-top: 20px; font-size: 0.7rem; color: var(--text-light);
}

/* ===== Header ===== */
.app-header {
  background: linear-gradient(135deg, #2C5F7C 0%, #3A7CA5 100%);
  padding: 12px 16px;
  display: flex; align-items: center; gap: 10px;
  color: #fff; position: sticky; top: 0; z-index: 100;
  box-shadow: 0 2px 15px rgba(44,95,124,0.3);
  min-height: 56px;
}
.app-header h1 {
  font-family: 'Zen Maru Gothic', sans-serif;
  font-size: 0.9rem; font-weight: 700; flex: 1;
  line-height: 1.4;
}
.header-mascots { display: flex; gap: 4px; }
.header-mascot {
  width: 30px; height: 30px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 1rem; border: 2px solid rgba(255,255,255,0.3);
}
.api-key-btn {
  background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3);
  color: #fff; padding: 6px 12px; border-radius: 8px;
  font-size: 0.7rem; cursor: pointer; white-space: nowrap;
  font-family: inherit;
}
.api-key-btn:active { background: rgba(255,255,255,0.3); }
.api-key-btn.has-key { background: rgba(72,187,120,0.3); border-color: rgba(72,187,120,0.5); }

/* ===== Tabs ===== */
.tab-nav {
  display: flex; background: var(--card-bg);
  border-bottom: 2px solid var(--border);
  position: sticky; top: 56px; z-index: 90;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
.tab-btn {
  flex: 1; min-width: 0; padding: 12px 6px 10px;
  border: none; background: none; cursor: pointer;
  display: flex; flex-direction: column; align-items: center; gap: 3px;
  font-family: 'M PLUS Rounded 1c', sans-serif;
  font-size: 0.65rem; font-weight: 500;
  color: var(--text-light); transition: all 0.3s;
  border-bottom: 3px solid transparent;
  position: relative;
  -webkit-tap-highlight-color: transparent;
}
.tab-btn.active { font-weight: 700; }
.tab-btn[data-tab="import"].active { color: var(--camel); border-bottom-color: var(--camel); }
.tab-btn[data-tab="cards"].active { color: var(--primary); border-bottom-color: var(--primary); }
.tab-btn[data-tab="segment"].active { color: var(--dragon); border-bottom-color: var(--dragon); }
.tab-btn[data-tab="draft"].active { color: var(--sheep); border-bottom-color: var(--sheep); }
.tab-icon { font-size: 1.3rem; }
.tab-badge {
  position: absolute; top: 4px; right: 50%; transform: translateX(calc(50% + 12px));
  background: var(--dragon); color: #fff;
  font-size: 0.55rem; padding: 1px 5px; border-radius: 10px;
  min-width: 16px; text-align: center;
}

/* ===== Tab Content ===== */
.tab-content { display: none; padding: 16px; max-width: 800px; margin: 0 auto; padding-bottom: 40px; }
.tab-content.active { display: block; animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

/* ===== Character Bubble ===== */
.char-bubble {
  display: flex; gap: 12px; margin-bottom: 20px;
  animation: slideUp 0.5s ease;
}
@keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
.char-avatar {
  width: 48px; height: 48px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.6rem; flex-shrink: 0;
  box-shadow: 0 3px 10px rgba(0,0,0,0.1);
}
.char-avatar.camel { background: var(--camel-light); }
.char-avatar.dragon { background: var(--dragon-light); }
.char-avatar.sheep { background: var(--sheep-light); }
.char-speech {
  background: var(--card-bg); border-radius: var(--radius);
  padding: 14px 16px; box-shadow: var(--shadow);
  position: relative; font-size: 0.85rem; line-height: 1.7;
  flex: 1;
}
.char-speech::before {
  content: ''; position: absolute; left: -8px; top: 16px;
  border: 8px solid transparent; border-right-color: var(--card-bg);
  border-left: none;
}
.char-name {
  font-weight: 700; font-size: 0.75rem; margin-bottom: 4px;
}
.char-name.camel { color: var(--camel); }
.char-name.dragon { color: var(--dragon); }
.char-name.sheep { color: var(--sheep); }

/* ===== Cards ===== */
.card {
  background: var(--card-bg); border-radius: var(--radius);
  padding: 20px; margin-bottom: 16px;
  box-shadow: var(--shadow); transition: all 0.3s;
}
.card:hover { box-shadow: var(--shadow-hover); }
.card-title {
  font-family: 'Zen Maru Gothic', sans-serif;
  font-size: 0.95rem; font-weight: 700; margin-bottom: 12px;
  display: flex; align-items: center; gap: 8px;
}

/* ===== Import Tab ===== */
.import-zone {
  border: 3px dashed var(--camel);
  border-radius: var(--radius);
  padding: 36px 20px;
  text-align: center;
  background: var(--camel-bg);
  cursor: pointer;
  transition: all 0.3s;
  margin-bottom: 16px;
}
.import-zone:hover { background: var(--camel-light); }
.import-zone.dragover { background: var(--camel-light); transform: scale(1.02); border-color: var(--camel); }
.import-icon { font-size: 2.8rem; margin-bottom: 10px; }
.import-text { font-size: 0.85rem; color: var(--text-light); line-height: 1.6; }
.import-text strong { color: var(--camel); }

.sample-btn {
  display: inline-block; padding: 12px 28px;
  background: var(--camel); color: #fff; border: none;
  border-radius: 50px; cursor: pointer; font-weight: 700;
  font-family: inherit; font-size: 0.85rem;
  transition: all 0.3s;
}
.sample-btn:hover { background: #b87a3e; transform: translateY(-2px); }
.sample-btn:active { transform: translateY(0); }
.sample-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

.import-progress {
  display: none; margin-top: 20px;
}
.import-progress.show { display: block; }
.progress-bar {
  height: 10px; background: var(--border); border-radius: 5px; overflow: hidden;
}
.progress-fill {
  height: 100%; background: linear-gradient(90deg, var(--camel), var(--dragon));
  border-radius: 5px; transition: width 0.5s ease;
  width: 0;
}
.progress-text {
  font-size: 0.8rem; color: var(--text-light);
  margin-top: 8px; text-align: center;
}

/* ===== Cards List Tab ===== */
.search-bar {
  display: flex; gap: 8px; margin-bottom: 12px;
}
.search-input {
  flex: 1; padding: 10px 14px; border: 2px solid var(--border);
  border-radius: var(--radius-sm); font-family: inherit;
  font-size: 0.85rem; outline: none; transition: border-color 0.3s;
}
.search-input:focus { border-color: var(--primary); }
.filter-btn {
  padding: 10px 14px; border: 2px solid var(--border);
  border-radius: var(--radius-sm); background: var(--card-bg);
  cursor: pointer; font-size: 1rem; transition: all 0.2s;
  -webkit-tap-highlight-color: transparent;
}
.filter-btn.active { border-color: var(--primary); background: var(--primary-light); }
.stats-row {
  display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;
}
.stat-chip {
  padding: 6px 12px; border-radius: 50px;
  font-size: 0.7rem; font-weight: 700;
  display: flex; align-items: center; gap: 4px;
}
.stat-chip.total { background: var(--primary-light); color: var(--primary); }
.stat-chip.hot { background: #FED7D7; color: #C53030; }
.stat-chip.warm { background: #FEFCBF; color: #975A16; }
.stat-chip.cold { background: #BEE3F8; color: #2B6CB0; }

.biz-card {
  background: var(--card-bg); border-radius: var(--radius);
  padding: 14px; margin-bottom: 10px;
  box-shadow: var(--shadow); display: flex; gap: 12px;
  border-left: 4px solid var(--border);
  transition: all 0.2s; cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}
.biz-card.hot { border-left-color: var(--dragon); }
.biz-card.warm { border-left-color: var(--warning); }
.biz-card.cold { border-left-color: var(--sheep); }
.biz-card:active { transform: scale(0.99); }
.biz-card-avatar {
  width: 42px; height: 42px; border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.1rem; font-weight: 700; color: #fff;
  flex-shrink: 0;
}
.biz-card-avatar.hot { background: linear-gradient(135deg, #FC8181, #F56565); }
.biz-card-avatar.warm { background: linear-gradient(135deg, #ECC94B, #D69E2E); }
.biz-card-avatar.cold { background: linear-gradient(135deg, #90CDF4, #63B3ED); }
.biz-card-info { flex: 1; min-width: 0; }
.biz-card-name {
  font-weight: 700; font-size: 0.9rem; margin-bottom: 2px;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.biz-card-company {
  font-size: 0.75rem; color: var(--text-light); margin-bottom: 5px;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.biz-card-tags { display: flex; gap: 4px; flex-wrap: wrap; }
.tag {
  padding: 2px 7px; border-radius: 50px; font-size: 0.6rem;
  font-weight: 600;
}
.tag.intent { background: #E9D8FD; color: #6B46C1; }
.tag.industry { background: #C6F6D5; color: #276749; }
.tag.action { background: #FEFCBF; color: #975A16; }
.biz-card-date {
  font-size: 0.65rem; color: var(--text-light);
  text-align: right; white-space: nowrap;
}
.biz-card-check {
  display: flex; align-items: center;
}
.biz-card-check input[type="checkbox"] {
  width: 20px; height: 20px; accent-color: var(--primary);
  cursor: pointer;
}

/* ===== Segment Tab ===== */
.segment-result {
  background: var(--card-bg); border-radius: var(--radius);
  padding: 18px; margin-bottom: 14px; box-shadow: var(--shadow);
}
.segment-header {
  display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
}
.segment-title { font-weight: 700; font-size: 0.95rem; }
.segment-count {
  background: var(--dragon-light); color: var(--dragon);
  padding: 2px 10px; border-radius: 50px; font-size: 0.7rem; font-weight: 700;
}

/* ===== Draft Tab ===== */
.draft-card {
  background: var(--card-bg); border-radius: var(--radius);
  padding: 18px; margin-bottom: 14px; box-shadow: var(--shadow);
}
.draft-recipient {
  display: flex; align-items: center; gap: 10px; margin-bottom: 12px;
  padding-bottom: 12px; border-bottom: 1px solid var(--border);
}
.draft-recipient-name { font-weight: 700; font-size: 0.9rem; }
.draft-recipient-company { font-size: 0.75rem; color: var(--text-light); }
.draft-type {
  display: inline-block; padding: 3px 10px; border-radius: 50px;
  font-size: 0.65rem; font-weight: 700; margin-left: auto; white-space: nowrap;
}
.draft-type.story { background: #E9D8FD; color: #6B46C1; }
.draft-type.problem { background: #FEFCBF; color: #975A16; }
.draft-subject {
  font-weight: 700; font-size: 0.85rem; margin-bottom: 8px;
  color: var(--primary);
}
.draft-body {
  font-size: 0.8rem; line-height: 1.8; color: var(--text);
  white-space: pre-wrap; margin-bottom: 12px;
  max-height: 200px; overflow-y: auto;
  padding: 12px; background: #F7FAFC; border-radius: var(--radius-sm);
}
.draft-actions {
  display: flex; gap: 8px; flex-wrap: wrap;
}
.draft-btn {
  padding: 8px 14px; border-radius: 50px; font-family: inherit;
  font-size: 0.75rem; font-weight: 600; cursor: pointer;
  border: none; transition: all 0.2s;
  -webkit-tap-highlight-color: transparent;
}
.draft-btn:active { transform: scale(0.95); }
.draft-btn.send { background: var(--sheep); color: #fff; }
.draft-btn.edit { background: var(--sheep-light); color: var(--sheep); }
.draft-btn.copy { background: var(--primary-light); color: var(--primary); }

/* ===== Generate Buttons ===== */
.generate-section {
  text-align: center; padding: 20px; margin-bottom: 16px;
}
.generate-btn {
  padding: 16px 32px; border: none; border-radius: 50px;
  font-family: inherit; font-size: 1rem; font-weight: 700;
  cursor: pointer; transition: all 0.3s;
  display: inline-flex; align-items: center; gap: 10px;
}
.generate-btn.dragon-btn {
  background: linear-gradient(135deg, var(--dragon), #E85D5D, #FF8C42);
  color: #fff;
  box-shadow: 0 4px 20px rgba(199,75,80,0.3);
}
.generate-btn.sheep-btn {
  background: linear-gradient(135deg, var(--sheep), #9AABDD, #B8C7F0);
  color: #fff;
  box-shadow: 0 4px 20px rgba(123,142,200,0.3);
}
.generate-btn:hover { transform: translateY(-3px); }
.generate-btn:active { transform: translateY(0); }
.generate-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

/* ===== Modals ===== */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.5);
  z-index: 1000; display: none; align-items: center; justify-content: center;
  padding: 20px; backdrop-filter: blur(2px);
}
.modal-overlay.show { display: flex; }
.modal {
  background: var(--card-bg); border-radius: var(--radius);
  padding: 24px; max-width: 440px; width: 100%;
  box-shadow: 0 20px 60px rgba(0,0,0,0.2);
  animation: modalIn 0.3s ease;
}
@keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
.modal h3 {
  font-family: 'Zen Maru Gothic', sans-serif;
  margin-bottom: 12px; font-size: 1rem;
}
.modal p { font-size: 0.8rem; color: var(--text-light); margin-bottom: 12px; line-height: 1.6; }
.modal-input {
  width: 100%; padding: 10px 14px; border: 2px solid var(--border);
  border-radius: var(--radius-sm); font-family: inherit; font-size: 0.85rem;
  outline: none; margin-bottom: 12px;
}
.modal-input:focus { border-color: var(--primary); }
.modal-btns { display: flex; gap: 10px; justify-content: flex-end; }
.modal-btn {
  padding: 10px 24px; border: none; border-radius: 50px;
  font-family: inherit; font-weight: 700; cursor: pointer;
  font-size: 0.8rem; transition: all 0.2s;
}
.modal-btn:active { transform: scale(0.95); }
.modal-btn.cancel { background: var(--border); color: var(--text); }
.modal-btn.save { background: var(--primary); color: #fff; }

.detail-modal {
  background: var(--card-bg); border-radius: var(--radius);
  padding: 0; max-width: 500px; width: 100%;
  box-shadow: 0 20px 60px rgba(0,0,0,0.2);
  max-height: 80vh; overflow-y: auto;
  animation: modalIn 0.3s ease;
}
.detail-header {
  padding: 20px; text-align: center;
  border-bottom: 1px solid var(--border);
}
.detail-avatar {
  width: 60px; height: 60px; border-radius: 18px; margin: 0 auto 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.5rem; font-weight: 900; color: #fff;
}
.detail-name { font-size: 1.1rem; font-weight: 700; }
.detail-company { color: var(--text-light); font-size: 0.85rem; }
.detail-body { padding: 16px; }
.detail-row {
  display: flex; justify-content: space-between; padding: 10px 0;
  border-bottom: 1px solid var(--border);
  font-size: 0.8rem;
}
.detail-label { color: var(--text-light); flex-shrink: 0; }
.detail-value { font-weight: 600; text-align: right; max-width: 60%; word-break: break-all; }
.detail-memo {
  margin-top: 12px; padding: 12px; background: #F7FAFC;
  border-radius: var(--radius-sm); font-size: 0.8rem; line-height: 1.7;
}
.detail-close {
  display: block; width: 100%; padding: 14px; border: none;
  background: var(--primary); color: #fff; font-family: inherit;
  font-size: 0.85rem; font-weight: 700; cursor: pointer;
  border-radius: 0 0 var(--radius) var(--radius);
}

/* ===== Loading ===== */
.loading { display: none; text-align: center; padding: 30px; }
.loading.show { display: block; }
.spinner {
  width: 48px; height: 48px; margin: 0 auto 14px;
  border: 4px solid var(--border);
  border-top-color: var(--dragon);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-text { font-size: 0.85rem; color: var(--text-light); line-height: 1.7; }
.loading-char { font-size: 2rem; margin-bottom: 8px; }

/* ===== Toast ===== */
.toast {
  position: fixed; top: 16px; left: 50%; z-index: 2000;
  padding: 12px 24px; border-radius: var(--radius-sm);
  color: #fff; font-weight: 600; font-size: 0.8rem;
  transform: translate(-50%, -120%); transition: transform 0.4s ease;
  box-shadow: 0 4px 20px rgba(0,0,0,0.25);
  max-width: 90vw; text-align: center;
}
.toast.show { transform: translate(-50%, 0); }
.toast.success { background: var(--success); }
.toast.error { background: #E53E3E; }
.toast.info { background: var(--primary); }

/* ===== Empty State ===== */
.empty-state {
  text-align: center; padding: 40px 20px;
  color: var(--text-light);
}
.empty-icon { font-size: 3rem; margin-bottom: 12px; opacity: 0.5; }
.empty-text { font-size: 0.85rem; line-height: 1.7; }

/* ===== Select Bar ===== */
.select-bar {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 14px; background: var(--primary-light);
  border-radius: var(--radius-sm); margin-bottom: 10px;
  font-size: 0.8rem;
}
.select-bar label { display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 600; }
.select-bar .count { margin-left: auto; color: var(--primary); font-weight: 700; }

/* Edit Modal */
.edit-area {
  width: 100%; min-height: 200px; padding: 12px;
  border: 2px solid var(--border); border-radius: var(--radius-sm);
  font-family: inherit; font-size: 0.8rem; line-height: 1.8;
  resize: vertical; outline: none;
}
.edit-area:focus { border-color: var(--sheep); }

/* ===== Responsive ===== */
@media (max-width: 480px) {
  .splash-title { font-size: 1.2rem; }
  .splash-characters { gap: 16px; }
  .splash-char { width: 72px; height: 72px; font-size: 2.2rem; }
  .tab-btn { padding: 10px 4px; font-size: 0.6rem; }
  .tab-icon { font-size: 1.1rem; }
  .biz-card { padding: 12px; gap: 10px; }
  .biz-card-avatar { width: 38px; height: 38px; font-size: 1rem; }
  .generate-btn { padding: 14px 24px; font-size: 0.9rem; }
  .char-avatar { width: 42px; height: 42px; font-size: 1.4rem; }
  .char-speech { padding: 12px 14px; font-size: 0.8rem; }
  .draft-actions { gap: 6px; }
  .draft-btn { padding: 7px 12px; font-size: 0.7rem; }
}

/* ===== Step Guide ===== */
.step-guide {
  display: flex; align-items: center; gap: 6px; margin-bottom: 16px;
  padding: 10px 14px; background: var(--card-bg); border-radius: var(--radius-sm);
  box-shadow: var(--shadow); font-size: 0.75rem; color: var(--text-light);
}
.step-num {
  width: 22px; height: 22px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.65rem; font-weight: 900; color: #fff; flex-shrink: 0;
}
.step-num.done { background: var(--success); }
.step-num.current { background: var(--primary); }
.step-num.pending { background: var(--border); }
.step-arrow { color: var(--border); font-size: 0.7rem; }
</style>
</head>
<body>

<!-- ===== Splash Screen ===== -->
<div id="splash">
  <div class="splash-logo">AIã•ã‚“ã„ã‚“</div>
  <div class="splash-title">
    AIã•ã‚“ã„ã‚“ã‚³ãƒ³ã‚»ãƒ«ã‚¸ãƒ¥<br>
    ååˆºç®¡ç†ãƒ¡ãƒ¼ãƒªãƒ³ã‚°ãƒªã‚¹ãƒˆãã‚“
  </div>
  <div class="splash-subtitle">ååˆºã‚’ã€Œç®¡ç†ã€ã‹ã‚‰ã€Œå–¶æ¥­ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€ã¸</div>
  <div class="splash-characters">
    <div style="text-align:center;">
      <div class="splash-char">ğŸ«</div>
      <div class="splash-char-label" style="color:var(--camel);">ã‚‰ãã </div>
    </div>
    <div style="text-align:center;">
      <div class="splash-char">ğŸ‰</div>
      <div class="splash-char-label" style="color:var(--dragon);">ã‚ªãƒ­ãƒ</div>
    </div>
    <div style="text-align:center;">
      <div class="splash-char">ğŸ‘</div>
      <div class="splash-char-label" style="color:var(--sheep);">ãƒ’ãƒ„ã‚¸</div>
    </div>
  </div>
  <button class="splash-start" onclick="startApp()">ã¯ã˜ã‚ã‚‹</button>
  <div class="splash-version">v2.0 â€” Powered by Gemini AI</div>
</div>

<!-- ===== Main App ===== -->
<div id="app" style="display:none;">

  <header class="app-header">
    <div class="header-mascots">
      <div class="header-mascot" style="background:var(--camel-light);">ğŸ«</div>
      <div class="header-mascot" style="background:var(--dragon-light);">ğŸ‰</div>
      <div class="header-mascot" style="background:var(--sheep-light);">ğŸ‘</div>
    </div>
    <h1>ååˆºç®¡ç†ãƒ¡ãƒ¼ãƒªãƒ³ã‚°ãƒªã‚¹ãƒˆãã‚“</h1>
    <button class="api-key-btn" id="apiBtn" onclick="showApiKeyModal()">âš™ï¸ APIè¨­å®š</button>
  </header>

  <nav class="tab-nav">
    <button class="tab-btn active" data-tab="import" onclick="switchTab('import')">
      <span class="tab-icon">ğŸ«</span>ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    </button>
    <button class="tab-btn" data-tab="cards" onclick="switchTab('cards')">
      <span class="tab-icon">ğŸ“‡</span>ååˆºä¸€è¦§
      <span class="tab-badge" id="cardsBadge" style="display:none;">0</span>
    </button>
    <button class="tab-btn" data-tab="segment" onclick="switchTab('segment')">
      <span class="tab-icon">ğŸ‰</span>ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ
    </button>
    <button class="tab-btn" data-tab="draft" onclick="switchTab('draft')">
      <span class="tab-icon">ğŸ‘</span>ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ã
    </button>
  </nav>

  <!-- ===== Import Tab ===== -->
  <div class="tab-content active" id="tab-import">
    <div class="char-bubble">
      <div class="char-avatar camel">ğŸ«</div>
      <div class="char-speech">
        <div class="char-name camel">ã‚‰ãã ï¼ˆãƒ‡ãƒ¼ã‚¿åŸºç›¤æ‹…å½“ï¼‰</div>
        Eightã‹ã‚‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸååˆºCSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ã­ï¼<br>
        å°å…¥åˆæ—¥ã‹ã‚‰å³æˆ¦åŠ›ã«ã™ã‚‹ã‚ˆã€‚ğŸ“‹
      </div>
    </div>
    <div class="import-zone" id="importZone" onclick="document.getElementById('csvInput').click()">
      <div class="import-icon">ğŸ“</div>
      <div class="import-text">
        <strong>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</strong><br>
        ã¾ãŸã¯ã‚¿ãƒƒãƒ—ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ<br>
        <small>Eight / Sansan / ä¸€èˆ¬CSVå¯¾å¿œ</small>
      </div>
      <input type="file" id="csvInput" accept=".csv,.txt" style="display:none;" onchange="handleCSV(event)">
    </div>
    <div style="text-align:center; margin-bottom: 20px;">
      <button class="sample-btn" id="sampleBtn" onclick="loadSampleData()">
        ğŸ“‹ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã§ä½“é¨“ã™ã‚‹
      </button>
    </div>
    <div class="import-progress" id="importProgress">
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      <div class="progress-text" id="progressText">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
    <div class="card" style="margin-top:16px;">
      <div class="card-title">ğŸ“– å¯¾å¿œCSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ</div>
      <div style="font-size:0.8rem; color:var(--text-light); line-height:1.8;">
        ä»¥ä¸‹ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å«ã‚€CSVã«å¯¾å¿œã—ã¦ã„ã¾ã™ï¼š<br>
        <code style="background:#F0F4F8; padding:2px 6px; border-radius:4px; font-size:0.75rem;">
          å§“, å, ä¼šç¤¾å, éƒ¨ç½²å, å½¹è·, ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹, é›»è©±ç•ªå·, ãƒ¡ãƒ¢, ååˆºäº¤æ›æ—¥
        </code><br>
        â€»ãƒ˜ãƒƒãƒ€ãƒ¼åã¯æŸ”è»Ÿã«èªè­˜ã—ã¾ã™ï¼ˆè‹±èªåã«ã‚‚å¯¾å¿œï¼‰
      </div>
    </div>
  </div>

  <!-- ===== Cards Tab ===== -->
  <div class="tab-content" id="tab-cards">
    <div class="search-bar">
      <input type="text" class="search-input" placeholder="ğŸ” åå‰ãƒ»ä¼šç¤¾åãƒ»ã‚¿ã‚°ã§æ¤œç´¢..." id="searchInput" oninput="applyFilters()">
      <button class="filter-btn" id="filterBtn" onclick="cycleFilter()">ğŸ·ï¸</button>
    </div>
    <div class="stats-row" id="statsRow"></div>
    <div class="select-bar" id="selectBar" style="display:none;">
      <label><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"> ã™ã¹ã¦é¸æŠ</label>
      <span class="count" id="selectedCount">0ä»¶é¸æŠä¸­</span>
    </div>
    <div id="cardsList">
      <div class="empty-state">
        <div class="empty-icon">ğŸ“‡</div>
        <div class="empty-text">ã¾ã ååˆºãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>ã€Œã‚¤ãƒ³ãƒãƒ¼ãƒˆã€ã‚¿ãƒ–ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šè¾¼ã¿ã¾ã—ã‚‡ã†ã€‚</div>
      </div>
    </div>
  </div>

  <!-- ===== Segment Tab ===== -->
  <div class="tab-content" id="tab-segment">
    <div class="char-bubble">
      <div class="char-avatar dragon">ğŸ‰</div>
      <div class="char-speech">
        <div class="char-name dragon">ã‚ªãƒ­ãƒï¼ˆãƒªã‚µãƒ¼ãƒæ‹…å½“ï¼‰</div>
        ååˆºãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ã€æœ€é©ãªãƒ¡ãƒ¼ãƒªãƒ³ã‚°ãƒªã‚¹ãƒˆã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹ã‚ˆï¼<br>
        3ã¤ã®é¦–ã§ã€Œä¼æ¥­ãƒªã‚µãƒ¼ãƒã€ã€Œå•†è«‡è¦ç´„ã€ã€Œãƒªã‚¹ãƒˆåˆ†é¡ã€ã‚’åŒæ™‚å®Ÿè¡Œã™ã‚‹ãï¼ğŸ”¥
      </div>
    </div>
    <div id="stepGuide1" class="step-guide">
      <span class="step-num pending" id="step1">1</span><span>ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</span>
      <span class="step-arrow">â†’</span>
      <span class="step-num current" id="step2">2</span><span>ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ†æ</span>
      <span class="step-arrow">â†’</span>
      <span class="step-num pending" id="step3">3</span><span>ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆ</span>
    </div>
    <div class="generate-section">
      <button class="generate-btn dragon-btn" id="segmentBtn" onclick="runSegmentation()">
        ğŸ‰ AIã§ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ†æã‚’å®Ÿè¡Œ
      </button>
      <p style="font-size:0.75rem; color:var(--text-light); margin-top:10px;">
        â€» APIã‚­ãƒ¼æœªè¨­å®šã§ã‚‚ãƒ­ãƒ¼ã‚«ãƒ«åˆ†æãŒå‹•ä½œã—ã¾ã™
      </p>
    </div>
    <div class="loading" id="segmentLoading">
      <div class="loading-char">ğŸ‰</div>
      <div class="spinner"></div>
      <div class="loading-text" id="segmentLoadingText">
        ã‚ªãƒ­ãƒã®3ã¤ã®é¦–ãŒä¸¦åˆ—ã§åˆ†æä¸­...<br>
        <small>ğŸ”´ é¦–1: ä¼æ¥­æƒ…å ±ãƒªã‚µãƒ¼ãƒä¸­...</small><br>
        <small>ğŸŸ¢ é¦–2: å•†è«‡ãƒ¡ãƒ¢è§£æä¸­...</small><br>
        <small>ğŸ”µ é¦–3: ãƒªã‚¹ãƒˆåˆ†é¡ä¸­...</small>
      </div>
    </div>
    <div id="segmentResults"></div>
  </div>

  <!-- ===== Draft Tab ===== -->
  <div class="tab-content" id="tab-draft">
    <div class="char-bubble">
      <div class="char-avatar sheep">ğŸ‘</div>
      <div class="char-speech">
        <div class="char-name sheep">ãƒ’ãƒ„ã‚¸ï¼ˆUI/UXæ‹…å½“ï¼‰</div>
        ã‚»ã‚°ãƒ¡ãƒ³ãƒˆçµæœã‚’å…ƒã«ã€ä¸€äººã²ã¨ã‚Šã«æœ€é©åŒ–ã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãã‚’ä½œæˆã™ã‚‹ã‚ˆâ™ª<br>
        ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºãƒ»ãƒˆãƒ¼ã‚¯ãƒ³ã§è‡ªå‹•æŒ¿å…¥ã—ã¾ã™âœ‰ï¸
      </div>
    </div>
    <div class="generate-section">
      <button class="generate-btn sheep-btn" id="draftBtn" onclick="generateDrafts()">
        ğŸ‘ ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºãƒ‰ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆ
      </button>
      <p style="font-size:0.75rem; color:var(--text-light); margin-top:10px;" id="draftHint">
        é¸æŠã—ãŸååˆºã€ã¾ãŸã¯Hot/Warmå…¨ä»¶ã«å¯¾ã—ã¦ç”Ÿæˆã—ã¾ã™
      </p>
    </div>
    <div class="loading" id="draftLoading">
      <div class="loading-char">ğŸ‘</div>
      <div class="spinner"></div>
      <div class="loading-text">
        ãƒ’ãƒ„ã‚¸ãŒãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãã‚’ä½œæˆä¸­...<br>
        <small>ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºãƒ»ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŒ¿å…¥ã—ã¦ã„ã¾ã™âœ¨</small>
      </div>
    </div>
    <div id="draftResults"></div>
  </div>
</div>

<!-- ===== Modals ===== -->
<div class="modal-overlay" id="apiModal">
  <div class="modal">
    <h3>âš™ï¸ Gemini APIè¨­å®š</h3>
    <p>Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚AIã«ã‚ˆã‚‹ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ†æã¨ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆã«ä½¿ç”¨ã—ã¾ã™ã€‚</p>
    <input type="password" class="modal-input" id="apiKeyInput" placeholder="AIza...">
    <p style="font-size:0.7rem;">â€» APIã‚­ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ¡ãƒ¢ãƒªã«ã®ã¿ä¿å­˜ã•ã‚Œã€å¤–éƒ¨ã«ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚<br>â€» æœªè¨­å®šã§ã‚‚ãƒ­ãƒ¼ã‚«ãƒ«åˆ†æãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œã—ã¾ã™ã€‚</p>
    <div class="modal-btns">
      <button class="modal-btn cancel" onclick="closeModal('apiModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="modal-btn save" onclick="saveApiKey()">ä¿å­˜</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="detailModal">
  <div class="detail-modal" id="detailContent"></div>
</div>

<div class="modal-overlay" id="editModal">
  <div class="modal" style="max-width:520px;">
    <h3>âœï¸ ãƒ¡ãƒ¼ãƒ«ç·¨é›†</h3>
    <p><strong>ä»¶å:</strong></p>
    <input type="text" class="modal-input" id="editSubject" style="margin-bottom:8px;">
    <p><strong>æœ¬æ–‡:</strong></p>
    <textarea class="edit-area" id="editBody"></textarea>
    <div class="modal-btns" style="margin-top:14px;">
      <button class="modal-btn cancel" onclick="closeModal('editModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="modal-btn save" onclick="saveEditDraft()">ä¿å­˜</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ===== Global State =====
let businessCards = [];
let drafts = [];
let geminiApiKey = '';
let selectedCards = new Set();
let editingDraftIndex = -1;
let currentFilter = 'all'; // all, hot, warm, cold
let segmentationDone = false;

// ===== Utilities =====
function esc(str) {
  if (!str) return '';
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

// ===== Splash & App Init =====
function startApp() {
  document.getElementById('splash').classList.add('hidden');
  document.getElementById('app').style.display = 'block';
}

// ===== Tab Navigation =====
function switchTab(tabId) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + tabId).classList.add('active');
  document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
  updateStepGuide();
}

// ===== Toast =====
function showToast(msg, type = 'info') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast ' + type + ' show';
  clearTimeout(t._timer);
  t._timer = setTimeout(() => t.classList.remove('show'), 3000);
}

// ===== Modal Helpers =====
function closeModal(id) {
  document.getElementById(id).classList.remove('show');
}
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => {
    if (e.target === overlay) overlay.classList.remove('show');
  });
});

// ===== API Key =====
function showApiKeyModal() {
  document.getElementById('apiKeyInput').value = geminiApiKey;
  document.getElementById('apiModal').classList.add('show');
}
function saveApiKey() {
  geminiApiKey = document.getElementById('apiKeyInput').value.trim();
  closeModal('apiModal');
  const btn = document.getElementById('apiBtn');
  if (geminiApiKey) {
    btn.classList.add('has-key');
    btn.textContent = 'âœ… APIè¨­å®šæ¸ˆ';
  } else {
    btn.classList.remove('has-key');
    btn.textContent = 'âš™ï¸ APIè¨­å®š';
  }
  showToast(geminiApiKey ? 'APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ' : 'APIã‚­ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
}

// ===== CSV Import =====
const importZone = document.getElementById('importZone');
importZone.addEventListener('dragover', e => { e.preventDefault(); importZone.classList.add('dragover'); });
importZone.addEventListener('dragleave', () => importZone.classList.remove('dragover'));
importZone.addEventListener('drop', e => {
  e.preventDefault(); importZone.classList.remove('dragover');
  const file = e.dataTransfer.files[0];
  if (file) processCSVFile(file);
});

function handleCSV(e) {
  const file = e.target.files[0];
  if (file) processCSVFile(file);
  e.target.value = ''; // reset for re-upload
}

function processCSVFile(file) {
  const reader = new FileReader();
  reader.onload = e => {
    try {
      parseCSV(e.target.result);
    } catch (err) {
      showToast('CSVã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message, 'error');
    }
  };
  reader.readAsText(file, 'UTF-8');
}

function parseCSV(text) {
  const lines = text.split(/\r?\n/).filter(l => l.trim());
  if (lines.length < 2) { showToast('ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™', 'error'); return; }

  const headers = parseCSVLine(lines[0]).map(h => h.trim().toLowerCase());
  const mapHeader = h => {
    if (/å§“|last.*name|family/i.test(h)) return 'lastName';
    if (/å(?!åˆº)|first.*name|given/i.test(h)) return 'firstName';
    if (/ä¼šç¤¾|company|org/i.test(h)) return 'company';
    if (/éƒ¨ç½²|dept|department|division/i.test(h)) return 'department';
    if (/å½¹è·|title|position|job/i.test(h)) return 'title';
    if (/ãƒ¡ãƒ¼ãƒ«|email|e-mail|mail/i.test(h)) return 'email';
    if (/é›»è©±|phone|tel/i.test(h)) return 'phone';
    if (/ãƒ¡ãƒ¢|note|memo|å•†è«‡/i.test(h)) return 'memo';
    if (/æ—¥ä»˜|date|äº¤æ›æ—¥|ç™»éŒ²/i.test(h)) return 'date';
    return h;
  };
  const headerMap = headers.map(mapHeader);

  const cards = [];
  const baseId = Date.now();
  for (let i = 1; i < lines.length; i++) {
    const vals = parseCSVLine(lines[i]);
    if (vals.length < 2) continue;
    const card = { id: baseId + i, tags: [], segment: '', heat: 'cold' };
    headerMap.forEach((key, idx) => { if (vals[idx]) card[key] = vals[idx].trim(); });
    // BUG FIX: use continue instead of return
    if (!card.lastName && !card.firstName && !card.company) continue;
    card.name = ((card.lastName || '') + ' ' + (card.firstName || '')).trim();
    if (!card.name && card.company) card.name = card.company;
    if (!card.date) card.date = new Date().toISOString().split('T')[0];
    cards.push(card);
  }

  if (cards.length === 0) { showToast('æœ‰åŠ¹ãªååˆºãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'error'); return; }
  animateImport(cards);
}

function parseCSVLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    const c = line[i];
    if (c === '"') { inQuotes = !inQuotes; }
    else if (c === ',' && !inQuotes) { result.push(current); current = ''; }
    else { current += c; }
  }
  result.push(current);
  return result;
}

function animateImport(cards) {
  // Reset progress
  const prog = document.getElementById('importProgress');
  const fill = document.getElementById('progressFill');
  const text = document.getElementById('progressText');
  fill.style.width = '0%';
  prog.classList.add('show');

  const steps = [
    { p: 30, t: 'ğŸ« ã‚‰ãã ãŒCSVãƒ‡ãƒ¼ã‚¿ã‚’è§£æä¸­...' },
    { p: 60, t: 'ğŸ‰ ã‚ªãƒ­ãƒãŒé‡è¤‡ãƒã‚§ãƒƒã‚¯ä¸­...' },
    { p: 85, t: 'ğŸ‘ ãƒ’ãƒ„ã‚¸ãŒãƒ‡ãƒ¼ã‚¿ã‚’æ•´ç†ä¸­...' },
    { p: 100, t: 'âœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ï¼' }
  ];
  let i = 0;
  const interval = setInterval(() => {
    if (i < steps.length) {
      fill.style.width = steps[i].p + '%';
      text.textContent = steps[i].t;
      i++;
    } else {
      clearInterval(interval);
      businessCards = [...businessCards, ...cards];
      segmentationDone = false;
      updateCardsUI();
      showToast(`${cards.length}ä»¶ã®ååˆºã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼`, 'success');
      switchTab('cards');
    }
  }, 600);
}

// ===== Sample Data =====
function loadSampleData() {
  const btn = document.getElementById('sampleBtn');
  btn.disabled = true;

  const sampleCards = [
    { id: 101, lastName: 'ç”°ä¸­', firstName: 'å¤ªéƒ', name: 'ç”°ä¸­ å¤ªéƒ', company: 'æ ªå¼ä¼šç¤¾å±±é™°ãƒ†ãƒƒã‚¯', department: 'DXæ¨é€²éƒ¨', title: 'éƒ¨é•·', email: 'tanaka@sanin-tech.co.jp', phone: '0857-22-1234', memo: 'DXæ¨é€²ã«å¼·ã„é–¢å¿ƒã€‚æ¥æœŸã®äºˆç®—ã§AIå°å…¥ã‚’æ¤œè¨ä¸­ã€‚ã‚³ã‚¹ãƒˆå‰Šæ¸›ãŒæœ€å„ªå…ˆèª²é¡Œã€‚', date: '2026-02-15', tags: [], segment: '', heat: 'cold' },
    { id: 102, lastName: 'éˆ´æœ¨', firstName: 'èŠ±å­', name: 'éˆ´æœ¨ èŠ±å­', company: 'é³¥å–çœŒåº', department: 'æƒ…å ±æ”¿ç­–èª²', title: 'ä¸»æŸ»', email: 'suzuki@pref.tottori.lg.jp', phone: '0857-26-7000', memo: 'è‡ªæ²»ä½“DXã«é–¢å¿ƒã€‚ä½æ°‘ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚ªãƒ³ãƒ©ã‚¤ãƒ³åŒ–ã‚’æ¨é€²ä¸­ã€‚', date: '2026-02-14', tags: [], segment: '', heat: 'cold' },
    { id: 103, lastName: 'å±±æœ¬', firstName: 'å¥ä¸€', name: 'å±±æœ¬ å¥ä¸€', company: 'å¢ƒæ¸¯æ°´ç”£åŠ å·¥å”åŒçµ„åˆ', department: 'ä¼ç”»å®¤', title: 'å®¤é•·', email: 'yamamoto@sakaiminato-fish.jp', phone: '0859-44-2345', memo: 'æ°´ç”£åŠ å·¥ã®DXåŒ–ã«èˆˆå‘³ã€‚åœ¨åº«ç®¡ç†ã¨å‡ºè·ç®¡ç†ã®ã‚·ã‚¹ãƒ†ãƒ åŒ–ã‚’è€ƒãˆã¦ã„ã‚‹ã€‚', date: '2026-02-13', tags: [], segment: '', heat: 'cold' },
    { id: 104, lastName: 'ä½è—¤', firstName: 'ç¾å’²', name: 'ä½è—¤ ç¾å’²', company: 'æ¾æ±Ÿæ—…é¤¨çµ„åˆ', department: 'äº‹æ¥­æ¨é€²éƒ¨', title: 'ä¸»ä»»', email: 'sato@matsue-ryokan.or.jp', phone: '0852-21-5678', memo: 'ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰å¯¾å¿œã®AIãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã«é–¢å¿ƒã€‚å¤šè¨€èªå¯¾å¿œãŒæ€¥å‹™ã€‚', date: '2026-02-12', tags: [], segment: '', heat: 'cold' },
    { id: 105, lastName: 'ä¸­æ‘', firstName: 'å¤§è¼”', name: 'ä¸­æ‘ å¤§è¼”', company: 'æ ªå¼ä¼šç¤¾å‡ºé›²ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚º', department: 'å–¶æ¥­æœ¬éƒ¨', title: 'æœ¬éƒ¨é•·', email: 'nakamura@izumo-solutions.co.jp', phone: '0853-25-3456', memo: 'æ¥æœˆã®å¤§å‹æ¡ˆä»¶ã«å‘ã‘ã¦ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ä¼æ¥­ã‚’æ¢ç´¢ä¸­ã€‚SFAå°å…¥ã«å‰å‘ãã€‚äºˆç®—5000ä¸‡è¦æ¨¡ã€‚', date: '2026-02-10', tags: [], segment: '', heat: 'cold' },
    { id: 106, lastName: 'ä¼Šè—¤', firstName: 'è£•å­', name: 'ä¼Šè—¤ è£•å­', company: 'ç±³å­åŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼', department: 'äº‹å‹™å±€', title: 'å‰¯äº‹å‹™å±€é•·', email: 'ito@yonago-mc.jp', phone: '0859-33-7890', memo: 'é›»å­ã‚«ãƒ«ãƒ†ã®æ›´æ–°æ™‚æœŸã€‚AIè¨ºæ–­æ”¯æ´ã«ã‚‚é–¢å¿ƒã‚ã‚Šã€‚', date: '2026-02-08', tags: [], segment: '', heat: 'cold' },
    { id: 107, lastName: 'é«˜æ©‹', firstName: 'èª ', name: 'é«˜æ©‹ èª ', company: 'å¤§å±±ãƒªã‚¾ãƒ¼ãƒˆæ ªå¼ä¼šç¤¾', department: 'çµŒå–¶ä¼ç”»éƒ¨', title: 'ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼', email: 'takahashi@daisen-resort.co.jp', phone: '0859-52-4567', memo: 'è¦³å…‰åœ°ã®ã‚¹ãƒãƒ¼ãƒˆåŒ–ã€‚æ··é›‘äºˆæ¸¬AIã¨ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãƒ—ãƒ©ã‚¤ã‚·ãƒ³ã‚°ã«èˆˆå‘³ã€‚äºˆç®—ç¢ºä¿æ¸ˆã¿ã€‚', date: '2026-02-05', tags: [], segment: '', heat: 'cold' },
    { id: 108, lastName: 'å°æ—', firstName: 'çœŸç†', name: 'å°æ— çœŸç†', company: 'é³¥å–éŠ€è¡Œ', department: 'ãƒ‡ã‚¸ã‚¿ãƒ«æˆ¦ç•¥éƒ¨', title: 'èª²é•·', email: 'kobayashi@tottoribank.co.jp', phone: '0857-37-0100', memo: 'ãƒ•ã‚£ãƒ³ãƒ†ãƒƒã‚¯é ˜åŸŸã®ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚·ãƒƒãƒ—ã‚’æ¨¡ç´¢ä¸­ã€‚APIé€£æºã®äº‹ä¾‹ã‚’çŸ¥ã‚ŠãŸã„ã€‚', date: '2026-02-03', tags: [], segment: '', heat: 'cold' },
    { id: 109, lastName: 'æ¸¡è¾º', firstName: 'ç¿”å¤ª', name: 'æ¸¡è¾º ç¿”å¤ª', company: 'æ ªå¼ä¼šç¤¾ã—ã¾ã­è¾²æ¥­ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³', department: 'æŠ€è¡“é–‹ç™ºéƒ¨', title: 'ä¿‚é•·', email: 'watanabe@shimane-agri.co.jp', phone: '0852-55-6789', memo: 'ã‚¹ãƒãƒ¼ãƒˆè¾²æ¥­ã«å–ã‚Šçµ„ã‚“ã§ã„ã‚‹ã€‚ãƒ‰ãƒ­ãƒ¼ãƒ³ã¨AIã«ã‚ˆã‚‹è¾²ä½œç‰©ã®ç”Ÿè‚²ç®¡ç†ã€‚', date: '2026-01-28', tags: [], segment: '', heat: 'cold' },
    { id: 110, lastName: 'åŠ è—¤', firstName: 'åƒå°‹', name: 'åŠ è—¤ åƒå°‹', company: 'å€‰å‰å¸‚å•†å·¥ä¼š', department: 'çµŒå–¶æ”¯æ´èª²', title: 'æŒ‡å°å“¡', email: 'kato@kurayoshi-shoko.jp', phone: '0858-22-8888', memo: 'åœ°å…ƒä¸­å°ä¼æ¥­ã®ITå°å…¥æ”¯æ´ã‚’æ‹…å½“ã€‚è£œåŠ©é‡‘æ´»ç”¨ã®ã‚»ãƒŸãƒŠãƒ¼ã‚’ä¼ç”»ä¸­ã€‚æƒ…å ±åé›†æ®µéšã€‚', date: '2026-01-20', tags: [], segment: '', heat: 'cold' },
  ];

  // BUG FIX: properly handle sample data without race condition
  animateImport(sampleCards);
  setTimeout(() => { btn.disabled = false; }, 3200);
}

// ===== Cards UI =====
function updateCardsUI() {
  const badge = document.getElementById('cardsBadge');
  badge.style.display = businessCards.length > 0 ? 'block' : 'none';
  badge.textContent = businessCards.length;
  updateStats();
  applyFilters();
  updateStepGuide();
}

function updateStats() {
  const hot = businessCards.filter(c => c.heat === 'hot').length;
  const warm = businessCards.filter(c => c.heat === 'warm').length;
  const cold = businessCards.filter(c => c.heat === 'cold').length;
  document.getElementById('statsRow').innerHTML = `
    <div class="stat-chip total">ğŸ“‡ å…¨${businessCards.length}ä»¶</div>
    ${hot ? `<div class="stat-chip hot">ğŸ”¥ ãƒ›ãƒƒãƒˆ ${hot}ä»¶</div>` : ''}
    ${warm ? `<div class="stat-chip warm">â˜€ï¸ ã‚¦ã‚©ãƒ¼ãƒ  ${warm}ä»¶</div>` : ''}
    ${cold ? `<div class="stat-chip cold">â„ï¸ ã‚³ãƒ¼ãƒ«ãƒ‰ ${cold}ä»¶</div>` : ''}
  `;
  document.getElementById('selectBar').style.display = businessCards.length > 0 ? 'flex' : 'none';
}

// BUG FIX: unified filter + search function
function applyFilters() {
  const q = (document.getElementById('searchInput').value || '').toLowerCase();
  let cards = businessCards;
  // Apply heat filter
  if (currentFilter !== 'all') {
    cards = cards.filter(c => c.heat === currentFilter);
  }
  // Apply search
  if (q) {
    cards = cards.filter(c =>
      (c.name || '').toLowerCase().includes(q) ||
      (c.company || '').toLowerCase().includes(q) ||
      (c.tags || []).some(t => t.toLowerCase().includes(q)) ||
      (c.segment || '').toLowerCase().includes(q) ||
      (c.department || '').toLowerCase().includes(q)
    );
  }
  renderCards(cards);
}

function renderCards(cards) {
  const list = document.getElementById('cardsList');
  if (!cards || cards.length === 0) {
    const msg = businessCards.length === 0
      ? 'ã¾ã ååˆºãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>ã€Œã‚¤ãƒ³ãƒãƒ¼ãƒˆã€ã‚¿ãƒ–ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šè¾¼ã¿ã¾ã—ã‚‡ã†ã€‚'
      : 'è©²å½“ã™ã‚‹ååˆºãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
    list.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“‡</div><div class="empty-text">${msg}</div></div>`;
    return;
  }
  // XSS FIX: use esc() for all user data
  list.innerHTML = cards.map(c => {
    const initial = esc((c.lastName || c.name || '?')[0]);
    const tagsHtml = (c.tags || []).map(t => {
      const cls = /DX|AI|IoT|IT|ãƒ‡ã‚¸ã‚¿ãƒ«/.test(t) ? 'intent' : /äºˆç®—|æ¡ˆä»¶|æ¤œè¨/.test(t) ? 'action' : 'industry';
      return `<span class="tag ${cls}">${esc(t)}</span>`;
    }).join('');
    return `
      <div class="biz-card ${c.heat}" onclick="showDetail(${c.id})">
        <div class="biz-card-check" onclick="event.stopPropagation()">
          <input type="checkbox" ${selectedCards.has(c.id) ? 'checked' : ''} onchange="toggleCard(${c.id}, this.checked)">
        </div>
        <div class="biz-card-avatar ${c.heat}">${initial}</div>
        <div class="biz-card-info">
          <div class="biz-card-name">${esc(c.name) || 'åå‰ãªã—'}</div>
          <div class="biz-card-company">${esc(c.company) || ''}${c.title ? ' / ' + esc(c.title) : ''}</div>
          <div class="biz-card-tags">${tagsHtml}</div>
        </div>
        <div class="biz-card-date">${formatDate(c.date)}</div>
      </div>`;
  }).join('');
}

function formatDate(d) {
  if (!d) return '';
  try { const dt = new Date(d); return `${dt.getMonth()+1}/${dt.getDate()}`; }
  catch { return d; }
}

function toggleCard(id, checked) {
  if (checked) selectedCards.add(id); else selectedCards.delete(id);
  document.getElementById('selectedCount').textContent = selectedCards.size + 'ä»¶é¸æŠä¸­';
}
function toggleSelectAll() {
  const all = document.getElementById('selectAll').checked;
  if (all) businessCards.forEach(c => selectedCards.add(c.id)); else selectedCards.clear();
  document.getElementById('selectedCount').textContent = selectedCards.size + 'ä»¶é¸æŠä¸­';
  applyFilters();
}

// BUG FIX: filter cycle with visual feedback
function cycleFilter() {
  const btn = document.getElementById('filterBtn');
  const order = ['all', 'hot', 'warm', 'cold'];
  const idx = order.indexOf(currentFilter);
  currentFilter = order[(idx + 1) % order.length];
  const icons = { all: 'ğŸ·ï¸', hot: 'ğŸ”¥', warm: 'â˜€ï¸', cold: 'â„ï¸' };
  btn.textContent = icons[currentFilter];
  btn.classList.toggle('active', currentFilter !== 'all');
  applyFilters();
}

// ===== Detail Modal =====
function showDetail(id) {
  const c = businessCards.find(x => x.id === id);
  if (!c) return;
  const initial = esc((c.lastName || c.name || '?')[0]);
  const bg = c.heat === 'hot' ? 'background:linear-gradient(135deg,#FC8181,#F56565)'
    : c.heat === 'warm' ? 'background:linear-gradient(135deg,#ECC94B,#D69E2E)'
    : 'background:linear-gradient(135deg,#90CDF4,#63B3ED)';
  const heatLabel = c.heat === 'hot' ? 'ğŸ”¥ ãƒ›ãƒƒãƒˆ' : c.heat === 'warm' ? 'â˜€ï¸ ã‚¦ã‚©ãƒ¼ãƒ ' : 'â„ï¸ ã‚³ãƒ¼ãƒ«ãƒ‰';

  document.getElementById('detailContent').innerHTML = `
    <div class="detail-header">
      <div class="detail-avatar" style="${bg}">${initial}</div>
      <div class="detail-name">${esc(c.name) || 'åå‰ãªã—'}</div>
      <div class="detail-company">${esc(c.company) || ''}</div>
    </div>
    <div class="detail-body">
      ${c.department ? `<div class="detail-row"><span class="detail-label">éƒ¨ç½²</span><span class="detail-value">${esc(c.department)}</span></div>` : ''}
      ${c.title ? `<div class="detail-row"><span class="detail-label">å½¹è·</span><span class="detail-value">${esc(c.title)}</span></div>` : ''}
      ${c.email ? `<div class="detail-row"><span class="detail-label">ãƒ¡ãƒ¼ãƒ«</span><span class="detail-value">${esc(c.email)}</span></div>` : ''}
      ${c.phone ? `<div class="detail-row"><span class="detail-label">é›»è©±</span><span class="detail-value">${esc(c.phone)}</span></div>` : ''}
      ${c.date ? `<div class="detail-row"><span class="detail-label">ååˆºäº¤æ›æ—¥</span><span class="detail-value">${esc(c.date)}</span></div>` : ''}
      <div class="detail-row"><span class="detail-label">æ¸©åº¦</span><span class="detail-value">${heatLabel}</span></div>
      ${c.segment ? `<div class="detail-row"><span class="detail-label">ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ</span><span class="detail-value">${esc(c.segment)}</span></div>` : ''}
      ${(c.tags && c.tags.length) ? `<div class="detail-row"><span class="detail-label">ã‚¿ã‚°</span><span class="detail-value">${c.tags.map(esc).join(', ')}</span></div>` : ''}
      ${c.memo ? `<div class="detail-memo"><strong>ğŸ“ å•†è«‡ãƒ¡ãƒ¢</strong><br>${esc(c.memo)}</div>` : ''}
    </div>
    <button class="detail-close" onclick="closeModal('detailModal')">é–‰ã˜ã‚‹</button>`;
  document.getElementById('detailModal').classList.add('show');
}

// ===== Step Guide =====
function updateStepGuide() {
  const s1 = document.getElementById('step1');
  const s2 = document.getElementById('step2');
  const s3 = document.getElementById('step3');
  if (!s1) return;
  s1.className = 'step-num ' + (businessCards.length > 0 ? 'done' : 'pending');
  s2.className = 'step-num ' + (segmentationDone ? 'done' : businessCards.length > 0 ? 'current' : 'pending');
  s3.className = 'step-num ' + (drafts.length > 0 ? 'done' : segmentationDone ? 'current' : 'pending');
}

// ===== Gemini API =====
async function callGemini(prompt) {
  if (!geminiApiKey) return null;
  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
  try {
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        generationConfig: { temperature: 0.7, maxOutputTokens: 4096 }
      })
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error.message);
    return data.candidates?.[0]?.content?.parts?.[0]?.text || '';
  } catch (err) {
    console.error('Gemini API error:', err);
    showToast('APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼: ' + err.message, 'error');
    return null;
  }
}

// ===== Segmentation =====
async function runSegmentation() {
  if (businessCards.length === 0) {
    showToast('å…ˆã«ååˆºãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„', 'error');
    switchTab('import');
    return;
  }
  const btn = document.getElementById('segmentBtn');
  const loading = document.getElementById('segmentLoading');
  btn.disabled = true;
  loading.classList.add('show');

  if (geminiApiKey) {
    const cardsData = businessCards.map(c => ({
      id: c.id, name: c.name, company: c.company, department: c.department,
      title: c.title, memo: c.memo, date: c.date
    }));
    const prompt = `ã‚ãªãŸã¯å–¶æ¥­æ”¯æ´AIã§ã™ã€‚ä»¥ä¸‹ã®ååˆºãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã€å„ååˆºã«å¯¾ã—ã¦ä»¥ä¸‹ã®æƒ…å ±ã‚’JSONå½¢å¼ã§è¿”ã—ã¦ãã ã•ã„ã€‚
å¿…ãšä»¥ä¸‹ã®JSONé…åˆ—å½¢å¼ã®ã¿ã‚’è¿”ã—ã¦ãã ã•ã„ï¼ˆèª¬æ˜æ–‡ã¯ä¸è¦ï¼‰ï¼š
[{"id":<ååˆºID>,"heat":"hot"|"warm"|"cold","segment":"ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå","tags":["ã‚¿ã‚°1","ã‚¿ã‚°2"],"reason":"åˆ†é¡ç†ç”±ï¼ˆ1æ–‡ã§ï¼‰"}]
heatåˆ¤å®šåŸºæº–:
- hot: äºˆç®—ã‚ã‚Šãƒ»å…·ä½“çš„ãªæ¡ˆä»¶ã‚ã‚Šãƒ»æ—©æœŸå°å…¥æ„æ¬²ãŒé«˜ã„
- warm: é–¢å¿ƒã‚ã‚Šãƒ»æ¤œè¨ä¸­ãƒ»äºˆç®—æ™‚æœŸãŒæ±ºã¾ã£ã¦ã„ã‚‹
- cold: æƒ…å ±åé›†æ®µéšãƒ»å…·ä½“çš„ãªè¨ˆç”»ãªã—
ååˆºãƒ‡ãƒ¼ã‚¿ï¼š
${JSON.stringify(cardsData, null, 2)}`;
    const result = await callGemini(prompt);
    if (result) {
      try {
        const cleaned = result.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        applySegmentation(JSON.parse(cleaned));
        btn.disabled = false;
        loading.classList.remove('show');
        return;
      } catch (err) {
        console.error('Parse error:', err);
      }
    }
  }
  // Fallback: local segmentation
  await new Promise(r => setTimeout(r, 1500)); // simulate processing
  localSegmentation();
  btn.disabled = false;
  loading.classList.remove('show');
}

function localSegmentation() {
  const results = businessCards.map(c => {
    const memo = (c.memo || '').toLowerCase();
    let heat = 'cold', segment = 'æƒ…å ±åé›†æ®µéš', tags = [];
    if (/äºˆç®—|æ¡ˆä»¶|å°å…¥|ç¢ºä¿æ¸ˆ|5000ä¸‡|å‰å‘ã/.test(memo)) { heat = 'hot'; segment = 'å³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¯¾è±¡'; }
    else if (/æ¤œè¨|é–¢å¿ƒ|èˆˆå‘³|è€ƒãˆã¦|æ¨é€²|æ¨¡ç´¢/.test(memo)) { heat = 'warm'; segment = 'è‚²æˆå¯¾è±¡'; }
    if (/dx|ãƒ‡ã‚¸ã‚¿ãƒ«|ai|iot/.test(memo)) tags.push('DXé–¢å¿ƒ');
    if (/ã‚³ã‚¹ãƒˆ|å‰Šæ¸›|åŠ¹ç‡/.test(memo)) tags.push('ã‚³ã‚¹ãƒˆå‰Šæ¸›');
    if (/äºˆç®—/.test(memo)) tags.push('äºˆç®—ã‚ã‚Š');
    if (/æ¥æœŸ|æ¥æœˆ|æ¥å¹´/.test(memo)) tags.push('æ¬¡æœŸæ¤œè¨');
    if (/it|ã‚·ã‚¹ãƒ†ãƒ |ã‚½ãƒ•ãƒˆ|sfa/.test(memo)) tags.push('ITæŠ•è³‡');
    if (/è¾²æ¥­|æ°´ç”£|æ¼æ¥­/.test(memo)) tags.push('ä¸€æ¬¡ç”£æ¥­');
    if (/è¦³å…‰|æ—…é¤¨|ãƒªã‚¾ãƒ¼ãƒˆ|ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰/.test(memo)) tags.push('è¦³å…‰æ¥­');
    if (/éŠ€è¡Œ|é‡‘è|ãƒ•ã‚£ãƒ³ãƒ†ãƒƒã‚¯/.test(memo)) tags.push('é‡‘è');
    if (/åŒ»ç™‚|ç—…é™¢|ã‚«ãƒ«ãƒ†/.test(memo)) tags.push('åŒ»ç™‚');
    if (/è‡ªæ²»ä½“|è¡Œæ”¿|çœŒåº|å¸‚/.test(memo)) tags.push('è¡Œæ”¿');
    if (/è£œåŠ©é‡‘|ã‚»ãƒŸãƒŠãƒ¼/.test(memo)) tags.push('è£œåŠ©é‡‘æ´»ç”¨');
    if (tags.length === 0) tags.push('ä¸€èˆ¬');
    return { id: c.id, heat, segment, tags, reason: 'ãƒ­ãƒ¼ã‚«ãƒ«åˆ†æ' };
  });
  applySegmentation(results);
}

function applySegmentation(results) {
  results.forEach(r => {
    const card = businessCards.find(c => c.id === r.id);
    if (card) {
      card.heat = r.heat || 'cold';
      card.segment = r.segment || '';
      card.tags = r.tags || [];
    }
  });
  segmentationDone = true;
  updateCardsUI();
  renderSegmentResults(results);
  showToast('ğŸ‰ ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ†æãŒå®Œäº†ã—ã¾ã—ãŸï¼', 'success');
}

function renderSegmentResults(results) {
  const grouped = {};
  results.forEach(r => {
    const seg = r.segment || 'æœªåˆ†é¡';
    if (!grouped[seg]) grouped[seg] = [];
    grouped[seg].push(r);
  });
  const container = document.getElementById('segmentResults');
  container.innerHTML = Object.entries(grouped).map(([seg, items]) => {
    const heatIcons = items.map(i => i.heat === 'hot' ? 'ğŸ”¥' : i.heat === 'warm' ? 'â˜€ï¸' : 'â„ï¸').join('');
    const names = items.map(i => {
      const card = businessCards.find(c => c.id === i.id);
      return card ? esc(card.name) : '';
    }).filter(Boolean).join('ã€');
    return `
      <div class="segment-result">
        <div class="segment-header">
          <span class="segment-title">${esc(seg)}</span>
          <span class="segment-count">${items.length}ä»¶</span>
        </div>
        <div style="font-size:0.85rem; margin-bottom:8px;">${heatIcons}</div>
        <div style="font-size:0.75rem; color:var(--text-light);">${names}</div>
        ${items[0].reason ? `<div style="font-size:0.7rem; color:var(--dragon); margin-top:8px;">ğŸ’¡ ${esc(items[0].reason)}</div>` : ''}
      </div>`;
  }).join('');
}

// ===== Email Draft =====
async function generateDrafts() {
  // BUG FIX: better target selection logic
  let targets;
  if (selectedCards.size > 0) {
    targets = businessCards.filter(c => selectedCards.has(c.id));
  } else if (segmentationDone) {
    targets = businessCards.filter(c => c.heat === 'hot' || c.heat === 'warm');
  } else {
    // No segmentation done, no selection - use all cards
    targets = businessCards;
  }

  if (targets.length === 0) {
    showToast('å¯¾è±¡ã®ååˆºãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚', 'error');
    return;
  }

  const btn = document.getElementById('draftBtn');
  const loading = document.getElementById('draftLoading');
  btn.disabled = true;
  loading.classList.add('show');

  if (geminiApiKey) {
    const targetsData = targets.map(c => ({
      name: c.name, company: c.company, department: c.department,
      title: c.title, memo: c.memo, segment: c.segment, heat: c.heat, tags: c.tags
    }));
    const prompt = `ã‚ãªãŸã¯å„ªç§€ãªå–¶æ¥­ãƒ¡ãƒ¼ãƒ«ä½œæˆAIã§ã™ã€‚ä»¥ä¸‹ã®ååˆºæƒ…å ±ã‚’å…ƒã«ã€ä¸€äººã²ã¨ã‚Šã«ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—ãƒ¡ãƒ¼ãƒ«ã®ä¸‹æ›¸ãã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
ä»¥ä¸‹ã®JSONé…åˆ—å½¢å¼ã®ã¿ã‚’è¿”ã—ã¦ãã ã•ã„ï¼ˆèª¬æ˜æ–‡ã¯ä¸è¦ï¼‰ï¼š
[{"recipient":"å—ä¿¡è€…å","company":"ä¼šç¤¾å","type":"story"ã¾ãŸã¯"problem","subject":"ãƒ¡ãƒ¼ãƒ«ä»¶å","body":"ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ï¼ˆæ”¹è¡Œã¯\\nã§ï¼‰","explanation":"ã“ã®ãƒ¡ãƒ¼ãƒ«ã®ç‹™ã„ï¼ˆ1æ–‡ã§ï¼‰"}]
ä½œæˆãƒ«ãƒ¼ãƒ«:
- hotã®äººã«ã¯problemå‹ï¼ˆROIé‡è¦–ãƒ»ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¿ƒé€²ï¼‰
- warmã®äººã«ã¯storyå‹ï¼ˆå…±æ„Ÿãƒ»èª²é¡Œè§£æ±ºãƒ»æƒ…å ±æä¾›ï¼‰
- coldã®äººã«ã¯storyå‹ï¼ˆè»½ã„æƒ…å ±æä¾›ãƒ»é–¢ä¿‚æ§‹ç¯‰ï¼‰
- å•†è«‡ãƒ¡ãƒ¢ã®å†…å®¹ã‚’å…·ä½“çš„ã«åæ˜ ã™ã‚‹ã“ã¨
- å†’é ­ã«ååˆºäº¤æ›ã®ãŠç¤¼ã‚’å…¥ã‚Œã‚‹
- è‡ªç„¶ãªæ—¥æœ¬èªãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒ¼ãƒ«ã®ä½“è£ã«ã™ã‚‹ã“ã¨
- æœ«å°¾ã«ã€Œâ€»æœ¬ãƒ¡ãƒ¼ãƒ«ã®é…ä¿¡åœæ­¢ã‚’ã”å¸Œæœ›ã®å ´åˆã¯ã“ã¡ã‚‰ã‹ã‚‰ãŠæ‰‹ç¶šããã ã•ã„ã€ã‚’å…¥ã‚Œã‚‹ã“ã¨
ååˆºãƒ‡ãƒ¼ã‚¿ï¼š
${JSON.stringify(targetsData, null, 2)}`;

    const result = await callGemini(prompt);
    if (result) {
      try {
        const cleaned = result.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        drafts = JSON.parse(cleaned);
        renderDrafts();
        showToast('ğŸ‘ ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼', 'success');
        btn.disabled = false;
        loading.classList.remove('show');
        updateStepGuide();
        return;
      } catch (err) { console.error('Parse error:', err); }
    }
  }
  // Fallback
  await new Promise(r => setTimeout(r, 1200));
  localDrafts(targets);
  btn.disabled = false;
  loading.classList.remove('show');
  updateStepGuide();
}

function localDrafts(targets) {
  drafts = targets.map(c => {
    const type = c.heat === 'hot' ? 'problem' : 'story';
    const keywords = c.memo ? c.memo.replace(/[ã€‚ã€]/g, ' ').split(/\s+/).filter(w => w.length >= 2).slice(0, 3).join('ã€') : 'ãƒ“ã‚¸ãƒã‚¹èª²é¡Œ';

    const body = type === 'problem'
      ? `${c.name} æ§˜\n\nå…ˆæ—¥ã¯ãŠååˆºäº¤æ›ã„ãŸã ãã€èª ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚\n${c.company}ã®${c.department || ''}ã®çš†æ§˜ã®${keywords}ã«é–¢ã™ã‚‹ãŠå–ã‚Šçµ„ã¿ã«ã¤ã„ã¦ã€å¤§å¤‰èˆˆå‘³æ·±ããŠè©±ã‚’ä¼ºã„ã¾ã—ãŸã€‚\n\nã•ã¦ã€${keywords}ã«é–¢é€£ã—ã¦ã€å¼Šç¤¾ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæˆæœã‚’ä¸Šã’ãŸäº‹ä¾‹ãŒã”ã–ã„ã¾ã™ã€‚\n\nâ–  å°å…¥åŠ¹æœï¼ˆå‚è€ƒäº‹ä¾‹ï¼‰\nãƒ»æ¥­å‹™åŠ¹ç‡ï¼šç´„30%ã®å·¥æ•°å‰Šæ¸›\nãƒ»ã‚³ã‚¹ãƒˆï¼šå¹´é–“ç´„500ä¸‡å††ã®ã‚³ã‚¹ãƒˆå‰Šæ¸›\nãƒ»å°å…¥æœŸé–“ï¼šæœ€çŸ­2é€±é–“ã§ã®ç¨¼åƒé–‹å§‹\n\nãœã²ä¸€åº¦ã€å¾¡ç¤¾ã®èª²é¡Œã«åˆã‚ã›ãŸå…·ä½“çš„ãªã”ææ¡ˆã‚’ã•ã›ã¦ã„ãŸã ã‘ã‚Œã°å¹¸ã„ã§ã™ã€‚\næ¥é€±ã‚ãŸã‚Šã§30åˆ†ã»ã©ãŠæ™‚é–“ã‚’ã„ãŸã ã‘ã¾ã™ã§ã—ã‚‡ã†ã‹ï¼Ÿ\n\nä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚\n\nâ€»æœ¬ãƒ¡ãƒ¼ãƒ«ã®é…ä¿¡åœæ­¢ã‚’ã”å¸Œæœ›ã®å ´åˆã¯ã“ã¡ã‚‰ã‹ã‚‰ãŠæ‰‹ç¶šããã ã•ã„ã€‚`
      : `${c.name} æ§˜\n\nå…ˆæ—¥ã¯ãŠååˆºäº¤æ›ã„ãŸã ãã€èª ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚\n${c.company}ã§ã®ãŠå–ã‚Šçµ„ã¿ã«ã¤ã„ã¦ãŠè©±ã‚’ä¼ºã„ã€å¤§å¤‰å‹‰å¼·ã«ãªã‚Šã¾ã—ãŸã€‚\n\n${keywords}ã®ãŠè©±ã¯éå¸¸ã«èˆˆå‘³æ·±ãã€åŒã˜èª²é¡Œã‚’ãŠæŒã¡ã®ä¼æ¥­æ§˜ã‚‚å¤šãã„ã‚‰ã£ã—ã‚ƒã„ã¾ã™ã€‚\n\nã¤ãã¾ã—ã¦ã¯ã€å‚è€ƒæƒ…å ±ã¨ã—ã¦${keywords}ã«é–¢ã™ã‚‹æœ€æ–°ã®ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ¬ãƒãƒ¼ãƒˆã‚’ãŠé€ã‚Šã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚\nãŠæ™‚é–“ã®ã‚ã‚‹æ™‚ã«ã”ä¸€èª­ã„ãŸã ã‘ã‚Œã°å¹¸ã„ã§ã™ã€‚\n\nä»Šå¾Œã¨ã‚‚æƒ…å ±äº¤æ›ã•ã›ã¦ã„ãŸã ã‘ã¾ã™ã¨å¬‰ã—ãå­˜ã˜ã¾ã™ã€‚\nå¼•ãç¶šãã©ã†ãã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚\n\nâ€»æœ¬ãƒ¡ãƒ¼ãƒ«ã®é…ä¿¡åœæ­¢ã‚’ã”å¸Œæœ›ã®å ´åˆã¯ã“ã¡ã‚‰ã‹ã‚‰ãŠæ‰‹ç¶šããã ã•ã„ã€‚`;

    return {
      recipient: c.name, company: c.company, type,
      subject: type === 'problem'
        ? `ã€ã”ææ¡ˆã€‘${keywords}ã®èª²é¡Œè§£æ±ºã«ã¤ã„ã¦`
        : `å…ˆæ—¥ã®å¾¡ç¤¼ã¨${keywords}ã«é–¢ã™ã‚‹æƒ…å ±å…±æœ‰`,
      body,
      explanation: type === 'problem'
        ? 'ROIã‚’å¼·èª¿ã—ã€å…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå•†è«‡è¨­å®šï¼‰ã‚’ä¿ƒã™problemå‹ãƒ¡ãƒ¼ãƒ«'
        : 'å…±æ„Ÿã¨æƒ…å ±æä¾›ã‚’é€šã˜ã¦é–¢ä¿‚æ§‹ç¯‰ã‚’å›³ã‚‹storyå‹ãƒ¡ãƒ¼ãƒ«'
    };
  });
  renderDrafts();
  showToast('ğŸ‘ ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ï¼‰', 'success');
}

function renderDrafts() {
  const container = document.getElementById('draftResults');
  container.innerHTML = drafts.map((d, i) => {
    const bodyHtml = esc((d.body || '').replace(/\\n/g, '\n')).replace(/\n/g, '<br>');
    return `
    <div class="draft-card">
      <div class="draft-recipient">
        <div>
          <div class="draft-recipient-name">${esc(d.recipient)}</div>
          <div class="draft-recipient-company">${esc(d.company) || ''}</div>
        </div>
        <span class="draft-type ${d.type}">${d.type === 'story' ? 'ğŸ“– ã‚¹ãƒˆãƒ¼ãƒªãƒ¼å‹' : 'âš¡ å•é¡Œæèµ·å‹'}</span>
      </div>
      <div class="draft-subject">ğŸ“§ ${esc(d.subject)}</div>
      <div class="draft-body">${bodyHtml}</div>
      ${d.explanation ? `<div style="font-size:0.7rem; color:var(--sheep); margin-bottom:10px;">ğŸ‘ ${esc(d.explanation)}</div>` : ''}
      <div class="draft-actions">
        <button class="draft-btn send" onclick="openMailto(${i})">ğŸ“¤ ãƒ¡ãƒ¼ãƒ©ãƒ¼ã§é–‹ã</button>
        <button class="draft-btn edit" onclick="editDraft(${i})">âœï¸ ç·¨é›†</button>
        <button class="draft-btn copy" onclick="copyDraft(${i})">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
      </div>
    </div>`;
  }).join('');
}

function openMailto(i) {
  const d = drafts[i];
  const card = businessCards.find(c => c.name === d.recipient);
  const email = card?.email || '';
  const subject = encodeURIComponent(d.subject || '');
  const body = encodeURIComponent((d.body || '').replace(/\\n/g, '\n'));
  window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
}

function editDraft(i) {
  editingDraftIndex = i;
  const d = drafts[i];
  document.getElementById('editSubject').value = d.subject || '';
  document.getElementById('editBody').value = (d.body || '').replace(/\\n/g, '\n');
  document.getElementById('editModal').classList.add('show');
}

function saveEditDraft() {
  if (editingDraftIndex >= 0 && editingDraftIndex < drafts.length) {
    drafts[editingDraftIndex].subject = document.getElementById('editSubject').value;
    drafts[editingDraftIndex].body = document.getElementById('editBody').value;
    renderDrafts();
    closeModal('editModal');
    showToast('ãƒ¡ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
  }
}

function copyDraft(i) {
  const d = drafts[i];
  const text = `ä»¶å: ${d.subject}\n\n${(d.body || '').replace(/\\n/g, '\n')}`;
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(
      () => showToast('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success'),
      () => fallbackCopy(text)
    );
  } else {
    fallbackCopy(text);
  }
}
function fallbackCopy(text) {
  const ta = document.createElement('textarea');
  ta.value = text; ta.style.position = 'fixed'; ta.style.opacity = '0';
  document.body.appendChild(ta);
  ta.select(); document.execCommand('copy');
  document.body.removeChild(ta);
  showToast('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
}
</script>
</body>
</html>
